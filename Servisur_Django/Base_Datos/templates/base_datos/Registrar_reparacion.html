{% extends "base_datos/base.html" %}
<!-- üßç Datos del cliente -->
{% load static %}
<!-- üßç Datos del cliente -->
{% block title%}RegistrarReparaci√≥n - Servisur{% endblock %} {% block content %}
<link rel="stylesheet" href="{% static 'css/panel.css' %}" />

<div class="d-flex flex-column min-vh-100">
  <div class="container py-4">
    <h3 class="mb-3 text-secondary">Registrar Reparaci√≥n</h3>

    {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
      <div
        class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}"
      >
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}

      <div class="row gx-3">
        <!-- üßç Datos del cliente -->
        <div class="col-12">
          <div class="card mb-3 p-3 animate-slide-up">
            <h6 class="mb-3">üßç Datos del cliente</h6>

            <!-- üîò Selector de origen -->
            <div class="mb-3 d-flex gap-2">
              <button
                type="button"
                id="btn-rut"
                class="btn btn-outline-primary btn-sm"
              >
                RUT
              </button>
              <button
                type="button"
                id="btn-extranjero"
                class="btn btn-outline-secondary btn-sm"
              >
                Extranjero
              </button>
            </div>

            <!-- üÜî Campo de identificaci√≥n -->
            <div class="mb-3">
              <label for="id_cliente-Rut" id="label-identificacion">RUT</label>
              <input
                type="text"
                id="id_cliente-Rut"
                name="cliente-Rut"
                class="form-control"
                placeholder="Ej: 12.345.678-9"
                required
              />
              <div class="form-text" id="ayuda-identificacion">
                Ingresa el RUT chileno con formato v√°lido.
              </div>
              <div class="invalid-feedback" id="error-identificacion">
                Ingresa un documento v√°lido.
              </div>
            </div>

            <!-- üë§ Nombre -->
            <div class="mb-3">
              <label for="id_cliente-Nombre">Nombre</label>
              <input
                type="text"
                id="id_cliente-Nombre"
                name="cliente-Nombre"
                class="form-control"
                required
              />
            </div>

            <!-- üë§ Apellido -->
            <div class="mb-3">
              <label for="id_cliente-Apellido">Apellido</label>
              <input
                type="text"
                id="id_cliente-Apellido"
                name="cliente-Apellido"
                class="form-control"
                required
              />
            </div>

            <!-- üìû Tel√©fono -->
            <div class="mb-3">
              <label for="id_cliente-Numero_telefono">Tel√©fono</label>
              <input
                type="tel"
                id="id_cliente-Numero_telefono"
                name="cliente-Numero_telefono"
                class="form-control"
                required
              />
            </div>
          </div>
        </div>
      </div>

      <!-- üíª Datos del equipo -->
      <div class="col-12">
        <div class="card mb-3 p-3 animate-slide-up">
          <h6 class="mb-3">Datos del equipo</h6>

          <!--MARCA -->
          <div class="mb-2">
            <label for="marca-select">Marca</label>
            <select
              id="marca-select"
              name="dispositivo-Marca"
              class="form-select"
              required
            >
              <option value="">Seleccione marca</option>
              {% for marca in dispositivo_form.fields.Marca.queryset %}
              <option value="{{ marca.id }}">{{ marca.Marca }}</option>
              {% endfor %}
              <option value="agregar_marca">‚ûï Agregar nueva marca</option>
            </select>
          </div>

          <div
            id="nuevo-bloque-marca-modelo"
            class="mb-2"
            style="display: none"
          >
            <label for="nueva_marca">Nueva marca</label>
            <input
              type="text"
              id="nueva_marca"
              name="nueva_marca"
              class="form-control"
            />
          </div>

          <!-- Modelo -->
          <div class="mb-2">
            <label for="modelo-select">Modelo</label>
            <select
              id="modelo-select"
              name="dispositivo-modelo"
              class="form-select"
            >
              <option value="">Seleccione modelo</option>
            </select>
          </div>

          <div id="nuevo-modelo-input" class="mb-2" style="display: none">
            <label for="nuevo_modelo">Nuevo modelo</label>
            <input
              type="text"
              id="nuevo_modelo"
              name="nuevo_modelo"
              class="form-control"
            />
          </div>

          <!-- üîê M√©todo de bloqueo -->
          <div class="mb-2">
            <label for="id_dispositivo-Metodo_Bloqueo">M√©todo de bloqueo</label>
            <select
              id="id_dispositivo-Metodo_Bloqueo"
              name="dispositivo-Metodo_Bloqueo"
              class="form-select"
              required
            >
              <option value="PIN">PIN</option>
              <option value="PASS">Contrase√±a</option>
              <option value="PATRON">Patr√≥n (matriz 3x3)</option>
            </select>

            <div id="guia-patron" class="mt-2" style="display: none">
              <img
                src="{% static 'img/patron_3x3.png' %}"
                alt="Gu√≠a patr√≥n 3x3"
                style="max-width: 180px"
              />
              <div class="form-text">
                Usa los n√∫meros como referencia para tu patr√≥n (ej: 1-5-9).
              </div>
            </div>
          </div>

          <!-- üîë C√≥digo de desbloqueo -->
          <div class="mb-2">
            <label for="id_dispositivo-Codigo_Bloqueo"
              >C√≥digo de desbloqueo</label
            >
            <input
              type="text"
              id="id_dispositivo-Codigo_Bloqueo"
              name="dispositivo-Codigo_Bloqueo"
              class="form-control"
              required
            />
          </div>

          <!-- ‚ö†Ô∏è Tipo de falla -->
          <div class="mb-2">
            <label for="id_dispositivo-Tipo_Falla">Tipo de falla</label>
            <select
              id="id_dispositivo-Tipo_Falla"
              name="dispositivo-Tipo_Falla"
              class="form-select"
              required
            >
              <option value="" disabled selected>Seleccione una falla</option>
              {% for falla in dispositivo_form.fields.Tipo_Falla.queryset %}
              <option value="{{ falla.id }}">{{ falla.Falla }}</option>
              {% endfor %}
              <option value="agregar_falla">‚ûï Agregar nueva falla</option>
            </select>
          </div>

          <!-- Campo oculto para nueva falla -->
          <div class="mb-2" id="campo-nueva-falla" style="display: none">
            <label for="nueva_falla">Nueva falla</label>
            <div class="input-group">
              <input
                type="text"
                id="nueva_falla"
                name="nueva_falla"
                class="form-control"
                placeholder="Describe la nueva falla"
              />
              <button
                type="button"
                id="btn-agregar-falla"
                class="btn btn-outline-primary"
              >
                Agregar
              </button>
            </div>
          </div>

          <!-- üìù Observaciones -->
          <div class="mb-2">
            <label for="id_dispositivo-Observaciones">Observaciones</label>
            <textarea
              id="id_dispositivo-Observaciones"
              name="dispositivo-Observaciones"
              class="form-control"
              rows="3"
              placeholder="Notas adicionales sobre el equipo o el cliente"
            ></textarea>
          </div>
        </div>

        <!-- üìã Detalles de la orden -->
        <div class="col-12">
          <div class="card mb-3 p-3 animate-slide-up">
            <h6 class="mb-3">Detalles de la orden</h6>

            <div class="mb-2">
              <label for="fecha_orden">Fecha de ingreso</label>
              <input
                type="date"
                id="fecha_orden"
                name="pedido-Fecha"
                class="form-control"
                required
              />
            </div>

            <div class="mb-2">
              <label for="costo_total">Costo total</label>
              <input
                type="number"
                id="costo_total"
                name="pedido-Coste"
                class="form-control"
                min="0"
                required
              />
            </div>

            <div class="mb-2">
              <label for="abono">Abono</label>
              <input
                type="number"
                id="abono"
                name="pedido-Abono"
                class="form-control"
                min="0"
              />
            </div>

            <div class="mb-2">
              <label for="restante">Restante</label>
              <input
                type="number"
                id="restante"
                name="pedido-Restante"
                class="form-control"
                readonly
              />
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Registrar</button>
      </div>
    </form>
  </div>

  <footer class="mt-auto text-center small text-muted">
    <p class="mb-1">
      Sistema Servisur &copy; {{ now|date:"Y" }} ‚Äî Panel de Registrar reparaci√≥n
    </p>
    <p class="mb-0">Desarrollado por el equipo t√©cnico | Versi√≥n 1.0</p>
  </footer>
</div>

<script src="{% static 'js/pedido.js' %}"></script>
<script src="{% static 'js/validaciones.js' %}"></script>

{% endblock %}
