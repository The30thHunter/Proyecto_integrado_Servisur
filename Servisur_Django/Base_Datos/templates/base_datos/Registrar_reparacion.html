{% extends "base_datos/base.html" %}
<!-- üßç Datos del cliente -->
{% load static %}
<!-- üßç Datos del cliente -->
{% block title %}Registrar Reparaci√≥n - Servisur{% endblock %}
<!-- üßç Datos del cliente -->
{% block content %}
<link rel="stylesheet" href="{% static 'css/panel.css' %}" />

<div class="d-flex flex-column min-vh-100">
  <div class="container py-4">
    <h3 class="mb-3 text-secondary">Registrar Reparaci√≥n</h3>

    {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
      <div
        class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}"
      >
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}

      <div class="row gx-3">
        <!-- üßç Datos del cliente -->
        <div class="col-12">
          <div class="card mb-3 p-3 animate-slide-up">
            <h6 class="mb-3">üßç Datos del cliente</h6>

            <!-- Nombre -->
            <div class="mb-3">
              <label for="id_Nombre">Nombre</label>
              <input
                type="text"
                id="id_Nombre"
                name="Nombre"
                class="form-control"
                placeholder="Ej: Juan"
                required
              />
              <div class="invalid-feedback">
                Debes ingresar al menos 5 caracteres.
              </div>
            </div>

            <!-- Apellido -->
            <div class="mb-3">
              <label for="id_Apellido">Apellido</label>
              <input
                type="text"
                id="id_Apellido"
                name="Apellido"
                class="form-control"
                placeholder="Ej: P√©rez"
                required
              />
              <div class="invalid-feedback">
                Debes ingresar al menos 5 caracteres.
              </div>
            </div>

            <!-- N√∫mero de tel√©fono -->
            <div class="mb-3">
              <label for="id_Numero_telefono">Tel√©fono</label>
              <input
                type="tel"
                id="id_Numero_telefono"
                name="Numero_telefono"
                class="form-control"
                placeholder="Ej: +56912345678"
                required
              />
              <div class="invalid-feedback">
                Ingresa un n√∫mero v√°lido (ej: +56912345678).
              </div>
            </div>

            <!-- Direcci√≥n -->
            <div class="mb-3">
              <label for="id_Direccion">Direcci√≥n</label>
              <input
                type="text"
                id="id_Direccion"
                name="Direccion"
                class="form-control"
                placeholder="Ej: Av. Siempre Viva 123"
                required
              />
              <div class="invalid-feedback">
                Ingresa una direcci√≥n v√°lida (m√≠nimo 5 caracteres).
              </div>
            </div>

            <!-- RUT -->
            <div class="mb-3">
              <label for="id_Rut">RUT</label>
              <input
                type="text"
                id="id_Rut"
                name="Rut"
                class="form-control"
                placeholder="Ej: 12345678K"
                required
              />
              <div class="invalid-feedback">
                Ingresa un RUT v√°lido sin puntos ni guion y con d√≠gito
                verificador (ej: 12345678K).
              </div>
            </div>
          </div>
        </div>

        <!-- üíª Datos del equipo -->
        <div class="col-12">
          <div class="card mb-3 p-3 animate-slide-up">
            <h6 class="mb-3">Datos del equipo</h6>

            <!-- Marca -->
            <div class="mb-2">
              <label for="marca-select">Marca</label>
              <select
                id="marca-select"
                name="dispositivo-Marca"
                class="form-select"
                required
              >
                <option value="">Seleccione marca</option>
                {% for marca in dispositivo_form.fields.Marca.queryset %}
                <option value="{{ marca.id }}">{{ marca.Marca }}</option>
                {% endfor %}
                <option value="agregar_marca">‚ûï Agregar nueva marca</option>
              </select>
              <div class="invalid-feedback">Selecciona una marca v√°lida.</div>
            </div>

            <!-- Nueva marca -->
            <div
              id="nuevo-bloque-marca-modelo"
              class="mb-2"
              style="display: none"
            >
              <label for="nueva_marca">Nueva marca</label>
              <input
                type="text"
                id="nueva_marca"
                name="nueva_marca"
                class="form-control"
                placeholder="Ej: Sony Ericsson"
                autocomplete="off"
              />
              <div class="invalid-feedback">
                Ingresa una marca v√°lida (m√≠nimo 4 caracteres, se permiten
                espacios).
              </div>
            </div>

            <!-- Modelo -->
            <div class="mb-2">
              <label for="modelo-select">Modelo</label>
              <select
                id="modelo-select"
                name="dispositivo-modelo"
                class="form-select"
                disabled
              >
                <option value="">Seleccione modelo</option>
              </select>
              <div class="invalid-feedback">
                Selecciona un modelo v√°lido o agrega uno nuevo.
              </div>
            </div>

            <!-- Nuevo modelo -->
            <div id="nuevo-modelo-input" class="mb-2" style="display: none">
              <label for="nuevo_modelo">Nuevo modelo</label>
              <input
                type="text"
                id="nuevo_modelo"
                name="nuevo_modelo"
                class="form-control"
                placeholder="Ej: Galaxy A51"
                autocomplete="off"
              />
              <div class="invalid-feedback">
                Ingresa el nombre del nuevo modelo.
              </div>
            </div>

            <!-- Tipo de falla -->
            <div class="mb-2">
              <label for="tipo_falla">Tipo de falla</label>
              <textarea
                id="tipo_falla"
                name="tipo_falla"
                class="form-control"
                rows="3"
                placeholder="Ej: No enciende, pantalla rota, no carga, etc."
                required
              ></textarea>
              <div class="invalid-feedback">
                Describe la falla con al menos 10 caracteres. Se permiten
                letras, n√∫meros y puntuaci√≥n b√°sica.
              </div>
            </div>

            <!-- C√≥digo de bloqueo -->
            <div class="mb-2">
              <label for="id_dispositivo-Codigo_Bloqueo"
                >C√≥digo de bloqueo</label
              >
              <input
                type="text"
                id="id_dispositivo-Codigo_Bloqueo"
                name="dispositivo-Codigo_Bloqueo"
                class="form-control"
                placeholder="Ej: 1234, patr√≥n Z, sin bloqueo"
              />
              <div class="invalid-feedback">
                Ingresa un c√≥digo de bloqueo v√°lido.
              </div>
            </div>
          </div>
        </div>

        <!-- üìã Detalles de la orden -->
        <div class="col-12">
          <div class="card mb-3 p-3 animate-slide-up">
            <h6 class="mb-3">Detalles de la orden</h6>

            <div class="mb-2">
              <label for="fecha_orden">Fecha de ingreso</label>
              <input
                type="date"
                id="fecha_orden"
                name="fecha_orden"
                class="form-control"
                required
              />
              <div class="invalid-feedback">
                Ingresa una fecha v√°lida. No puede estar vac√≠a ni ser futura.
              </div>
            </div>

            <div class="mb-2">
              <label for="costo_total">Costo total</label>
              <input
                type="number"
                id="costo_total"
                name="costo_total"
                class="form-control"
                placeholder="Ej: 25000"
                min="0"
                required
              />
              <div class="invalid-feedback">
                Ingresa un costo v√°lido (mayor a 0).
              </div>
            </div>

            <div class="mb-2">
              <label for="abono">Abono</label>
              <input
                type="number"
                id="abono"
                name="abono"
                class="form-control"
                placeholder="Ej: 10000"
                min="0"
              />
              <div class="invalid-feedback">
                El abono no puede ser mayor al costo.
              </div>
            </div>

            <div class="mb-2">
              <label for="restante">Restante</label>
              <input
                type="number"
                id="restante"
                name="restante"
                class="form-control"
                readonly
              />
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Registrar</button>
      </div>
    </form>
  </div>

  <!-- üìå Footer institucional -->
  <footer class="mt-auto text-center small text-muted">
    <hr />
    <p class="mb-1">
      Sistema Servisur &copy; {{ now|date:"Y" }} ‚Äî Registro de Reparaciones
    </p>
    <p class="mb-0">Desarrollado por el equipo t√©cnico | Versi√≥n 1.0</p>
  </footer>
</div>

<script src="{% static 'js/pedido.js' %}"></script>
<script src="{% static 'js/validaciones.js' %}"></script>
{% endblock %}
