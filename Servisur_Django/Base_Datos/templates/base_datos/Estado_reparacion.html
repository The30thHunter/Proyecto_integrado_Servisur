
{% extends "base_datos/base.html" %}
{% load static %}
{% block title %}Estado de Reparación - Servisur{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/panel.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<div class="estado-page py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="mb-0 text-secondary">Estado de Reparación</h3>
      <small class="text-muted">Busca y actualiza el estado de las órdenes</small>
    </div>
    <div>
      <div class="container mt-3">
        <button type="button" class="btn btn-circle" data-bs-toggle="modal" data-bs-target="#myModal">
          <img src="{% static 'img/Er.png' %}" class="info-img">
        </button>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="myModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Estado de reparaciones</h4>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              Esta página permite consultar el historial de reparaciones filtrando por RUT, nombre, número de orden o fecha. Los resultados se muestran en una tabla con opción de edición rápida.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- FORMULARIO DE BÚSQUEDA -->
  <form id="filtroForm" class="card mb-4 p-3 shadow-sm filtro-card" method="get" action="">
    <div class="row g-3">
      <div class="col-md-2">
        <label class="form-label small">Nro de orden</label>
        <input name="orden" id="f_orden" type="text" class="form-control form-control-sm" placeholder="Ej: 123" value="{{ filtros.orden }}">
      </div>
      <div class="col-md-2">
        <label class="form-label small">Nombre</label>
        <input name="nombre" id="f_nombre" type="text" class="form-control form-control-sm" placeholder="Nombre" value="{{ filtros.nombre }}">
      </div>
      <div class="col-md-2">
        <label class="form-label small">RUT / Doc</label>
        <input name="doc" id="f_doc" type="text" class="form-control form-control-sm" placeholder="RUT / DNI" value="{{ filtros.doc }}">
      </div>
      <div class="col-md-2">
        <label class="form-label small">Fecha</label>
        <input name="fecha" id="f_fecha" type="text" class="form-control form-control-sm" placeholder="dd/mm/YYYY ó YYYY-MM-DD" value="{{ filtros.fecha }}">
      </div>
      <div class="col-md-2">
        <label class="form-label small">Estado</label>
        <select name="estado" id="f_estado" class="form-select form-select-sm">
          <option value="">Todos</option>
          {% for code,label in estado_choices %}
            <option value="{{ code }}" {% if filtros.estado == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary btn-sm me-2">Buscar</button>
        <a href="{% url 'estado_reparacion' %}" class="btn btn-outline-secondary btn-sm">Limpiar</a>
      </div>
    </div>
  </form>

  <!-- TABLA -->
  <div class="card shadow-sm p-2 tabla-card">
    <div class="table-responsive">
      <table id="tablaPedidos" class="table table-hover align-middle mb-0">
        <thead class="table-header">
          <tr>
            <th>Nro orden</th>
            <th>Nombre y apellido</th>
            <th>Nro Documento</th>
            <th>Fecha</th>
            <th>Modelo</th>
            <th>Serie / MSI</th>
            <th>Trabajo a realizar</th>
            <th>Estado</th>
            <th style="min-width:170px">Acción</th>
          </tr>
        </thead>
        <tbody>
          {% if pedidos %}
            {% for p in pedidos %}
              <tr data-orden="{{ p.N_Orden }}" data-estado="{{ p.Estado }}">
                <td class="td-orden">{{ p.N_Orden|default_if_none:"-" }}</td>
                <td class="td-nombre">
                  {% if p.Dispositivo and p.Dispositivo.rut %}
                    {{ p.Dispositivo.rut.Nombre|default_if_none:"-" }} {{ p.Dispositivo.rut.Apellido|default_if_none:"-" }}
                  {% else %}-{% endif %}
                </td>
                <td class="td-rut">
                  {% if p.Dispositivo and p.Dispositivo.rut %}
                    {% if p.Dispositivo.rut.Rut %}
                      {{ p.Dispositivo.rut.Rut|default_if_none:"-" }}
                    {% elif p.Dispositivo.rut.DocumentoExtranjero %}
                      {{ p.Dispositivo.rut.DocumentoExtranjero|default_if_none:"-" }}
                    {% else %}
                      -
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="td-fecha">{{ p.Fecha|default_if_none:"-" }}</td>
                <td class="td-modelo">
                  {% if p.Dispositivo and p.Dispositivo.modelo %}
                    {{ p.Dispositivo.modelo.Marca.Marca|default_if_none:"-" }} {{ p.Dispositivo.modelo.Modelo|default_if_none:"-" }}
                  {% else %}-{% endif %}
                </td>
                <td class="td-serie">{{ p.Dispositivo.Codigo_Bloqueo|default_if_none:"-" }}</td>
                <td class="td-trabajo">{% if p.Tipo_de_falla %}{{ p.Tipo_de_falla.Falla|default_if_none:"-" }}{% else %}-{% endif %}</td>
                <td class="td-estado">
                  {% for code,label in estado_choices %}
                    {% if p.Estado == code %}{{ label }}{% endif %}
                  {% endfor %}
                </td>
                <td>
                  <form method="post" class="d-flex align-items-center" style="gap:6px;">
                    {% csrf_token %}
                    <input type="hidden" name="orden_id" value="{{ p.N_Orden }}">
                    <select name="nuevo_estado" class="form-select form-select-sm">
                      {% for code,label in estado_choices %}
                        <option value="{{ code }}" {% if p.Estado == code %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-sm btn-outline-primary">Guardar</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="9" class="text-center text-muted">No hay registros que mostrar.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-3 text-muted small">Nota: Cambiar el estado enviará el formulario (POST) y recargará la página para reflejar el cambio.</div>

  <footer class="mt-auto text-center small text-muted">
    <p class="mb-1">Sistema Servisur &copy; {{ now|date:"Y" }} — Estado de reparaciones</p>
    <p class="mb-0">Desarrollado por el equipo técnico | Versión 1.0</p>
  </footer>
</div>

{% endblock %}
